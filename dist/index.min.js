!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).PersistentWebSocket=n()}(this,function(){"use strict";return function(e,n,o,t){if("function"==typeof n&&("object"==typeof o&&(t=o),o=n,n=void 0),Array.isArray(n)||"object"!=typeof n||(t=n,n=void 0),"object"==typeof o&&(t=o,o=void 0),o||"undefined"!=typeof window&&(o=window.WebSocket,"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("online",T)),!o)throw new Error("Please supply a websocket library to use");t||(t={});var r,i=null,c=!1,u=null,a=null,f=null,s=null,l={},p={},d={},y={},m={CONNECTING:"CONNECTING"in o?o.CONNECTING:0,OPEN:"OPEN"in o?o.OPEN:1,CLOSING:"CLOSING"in o?o.CLOSING:2,CLOSED:"CLOSED"in o?o.CLOSED:3,get readyState(){return i.readyState},get protocol(){return i.protocol},get extensions(){return i.extensions},get bufferedAmount(){return i.bufferedAmount},get binaryType(){return i.binaryType},set binaryType(e){f=e,i.binaryType=e},connect:T,url:e,retries:0,pingTimeout:"pingTimeout"in t&&t.pingTimeout,maxTimeout:t.maxTimeout||3e5,maxRetries:t.maxRetries||0,nextReconnectDelay:t.nextReconnectDelay||function(e){return Math.min((1+Math.random())*Math.pow(1.5,e)*1e3,m.maxTimeout)},send:function(){i.send.apply(i,arguments)},close:function(){clearTimeout(u),i.close.apply(i,arguments)},onopen:t.onopen,onmessage:t.onmessage,onclose:t.onclose,onerror:t.onerror},E=function(e,n,o){return function(t,c,u){function a(n){u&&u.once&&i["on"===e?"off":"removeEventListener"](t,a),n&&"object"==typeof n&&r&&(n.reconnectDelay=r),c.apply(m,arguments)}t in n?n[t].push(c):n[t]=[c],t in o?o[t].push(a):o[t]=[a],i&&i[e](t,a)}},w=function(e,n,o){return function(t,r){var c=n[t].indexOf(r);-1!==c&&(i&&i[e](t,o[t][c]),n[t].splice(c,1),o[t].splice(c,1))}};return m.addEventListener=E("addEventListener",l,p),m.removeEventListener=w("removeEventListener",l,p),m.on=E("on",d,y),m.off=w("off",d,y),m.once=function(e,n){return m.on(e,n,{once:!0})},e&&T(),m;function T(e){if(clearTimeout(u),"string"==typeof e&&(m.url=e),i&&3!==i.readyState)return C(4665,"Manual connect initiated");c=!1,(i=new o("function"==typeof m.url?m.url(m):m.url,n,t)).onclose=v,i.onerror=b,i.onopen=h,i.onmessage=g,Object.keys(p).forEach(function(e){p[e].forEach(function(n){return i.addEventListener(e,n)})}),Object.keys(y).forEach(function(e){y[e].forEach(function(n){return i.on(e,n)})}),f&&(i.binaryType=f)}function v(e,n){clearTimeout(a),e.reconnectDelay=Math.ceil(x()),m.onclose&&m.onclose.apply(m,arguments)}function b(e){e||(e=new Error("UnknownError")),e.reconnectDelay=Math.ceil(x()),m.onerror&&m.onerror.apply(m,arguments)}function h(e){m.onopen&&m.onopen.apply(m,arguments),O(),s=Date.now()}function g(e){m.onmessage&&m.onmessage.apply(m,arguments),O()}function O(){m.pingTimeout&&(clearTimeout(a),a=setTimeout(N,m.pingTimeout))}function N(){C(4663,"No heartbeat received within "+m.pingTimeout+"ms")}function x(){return c?r-(Date.now()-c):(c=Date.now(),m.retries=s&&Date.now()-s>r?1:m.retries+1,m.maxRetries&&m.retries>=m.maxRetries?void 0:(r=m.nextReconnectDelay(m.retries),u=setTimeout(T,r),r))}function C(e,n){setTimeout(L,0,i);var o=function(e,n){var o;return"undefined"!=typeof window&&window.CloseEvent?o=new window.CloseEvent("HeartbeatTimeout",{wasClean:!0,code:e,reason:n}):((o=new Error("HeartbeatTimeout")).code=e,o.reason=n),o}(e,n);v(o),p.close&&p.close.forEach(function(e){return e(o)}),y.close&&y.close.forEach(function(o){return o(e,n,r)})}function L(e){e.onclose=e.onopen=e.onerror=e.onmessage=null,Object.keys(p).forEach(function(n){p[n].forEach(function(o){return e.removeEventListener(n,o)})}),Object.keys(y).forEach(function(n){y[n].forEach(function(o){return e.off(n,o)})}),e.close()}}});
